<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link href="projects.css" rel="stylesheet">
        <script src="../error.ts"></script>
        <script src="../api.mts" type="module"></script>
    </head>
    <body>
        <div id="error_list"></div>
        <a id="return">Return</a>
        <h3 id="title">Project</h3>
        <input id="tag" type="text" autofocus>
        <select name="status" id="status">
            <option value="1" selected>Requested</option>
            <option value="2">Prepped</option>
            <option value="3">Dispatched</option>
            <option value="5">Returned & Stored</option>
        </select>
        <script type="module">
            import { 
                authenticate, get_projects, assign_asset_to_project, 
                search_tag, set_assignment_status
            } from "../api.mts";
            const title = document.getElementById('title');
            const env = import.meta.env;
            const url = new URL(window.location.href);
            const project_id = url.searchParams.get("p");
            document.getElementById('return')
                .href = `/project/?p=${project_id}`;
            (async function () {
                await authenticate({formInput: env.VITE_USR, password: env.VITE_PASS});
                await get_projects()
                    .then((result) => {
                        const proj = result.find(
                            (project) => project.projects_id.toString() == project_id
                        ) || {projects_name: "Unknown Project"};
                        title.innerText = proj.projects_name;
                    });
                const tag = document.getElementById('tag');
                const status = document.getElementById('status');
                tag.onkeypress = async (e) => {
                    if (e.key == 'Enter') {
                        const asset = await search_tag(tag.value);
                        await assign_asset_to_project(project_id, asset.assets_id);
                        await set_assignment_status(project_id, status.value, asset.assets_tag);
                        tag.value = '';
                    }
                };
            })();
        </script>
    </body>
</html>